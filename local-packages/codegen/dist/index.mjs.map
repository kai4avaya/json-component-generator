{"version":3,"sources":["../src/traverse.ts","../src/serialize.ts"],"sourcesContent":["import type { UITree, UIElement } from \"@json-render/core\";\r\n\r\n/**\r\n * Visitor function for tree traversal\r\n */\r\nexport interface TreeVisitor {\r\n  (element: UIElement, depth: number, parent: UIElement | null): void;\r\n}\r\n\r\n/**\r\n * Traverse a UI tree depth-first\r\n */\r\nexport function traverseTree(\r\n  tree: UITree,\r\n  visitor: TreeVisitor,\r\n  startKey?: string,\r\n): void {\r\n  if (!tree || !tree.root) return;\r\n\r\n  const rootKey = startKey ?? tree.root;\r\n  const rootElement = tree.elements[rootKey];\r\n  if (!rootElement) return;\r\n\r\n  function visit(key: string, depth: number, parent: UIElement | null): void {\r\n    const element = tree.elements[key];\r\n    if (!element) return;\r\n\r\n    visitor(element, depth, parent);\r\n\r\n    if (element.children) {\r\n      for (const childKey of element.children) {\r\n        visit(childKey, depth + 1, element);\r\n      }\r\n    }\r\n  }\r\n\r\n  visit(rootKey, 0, null);\r\n}\r\n\r\n/**\r\n * Collect all unique component types used in a tree\r\n */\r\nexport function collectUsedComponents(tree: UITree): Set<string> {\r\n  const components = new Set<string>();\r\n\r\n  traverseTree(tree, (element) => {\r\n    components.add(element.type);\r\n  });\r\n\r\n  return components;\r\n}\r\n\r\n/**\r\n * Collect all data paths referenced in a tree\r\n */\r\nexport function collectDataPaths(tree: UITree): Set<string> {\r\n  const paths = new Set<string>();\r\n\r\n  traverseTree(tree, (element) => {\r\n    // Check props for data paths\r\n    for (const [propName, propValue] of Object.entries(element.props)) {\r\n      // Check for path props (e.g., valuePath, dataPath, bindPath)\r\n      if (typeof propValue === \"string\") {\r\n        if (\r\n          propName.endsWith(\"Path\") ||\r\n          propName === \"bindPath\" ||\r\n          propName === \"dataPath\"\r\n        ) {\r\n          paths.add(propValue);\r\n        }\r\n      }\r\n\r\n      // Check for dynamic value objects with path\r\n      if (\r\n        propValue &&\r\n        typeof propValue === \"object\" &&\r\n        \"path\" in propValue &&\r\n        typeof (propValue as { path: unknown }).path === \"string\"\r\n      ) {\r\n        paths.add((propValue as { path: string }).path);\r\n      }\r\n    }\r\n\r\n    // Check visibility conditions for paths\r\n    if (element.visible && typeof element.visible === \"object\") {\r\n      collectPathsFromCondition(element.visible, paths);\r\n    }\r\n  });\r\n\r\n  return paths;\r\n}\r\n\r\nfunction collectPathsFromCondition(\r\n  condition: unknown,\r\n  paths: Set<string>,\r\n): void {\r\n  if (!condition || typeof condition !== \"object\") return;\r\n\r\n  const cond = condition as Record<string, unknown>;\r\n\r\n  if (\"path\" in cond && typeof cond.path === \"string\") {\r\n    paths.add(cond.path);\r\n  }\r\n\r\n  if (\"and\" in cond && Array.isArray(cond.and)) {\r\n    for (const sub of cond.and) {\r\n      collectPathsFromCondition(sub, paths);\r\n    }\r\n  }\r\n\r\n  if (\"or\" in cond && Array.isArray(cond.or)) {\r\n    for (const sub of cond.or) {\r\n      collectPathsFromCondition(sub, paths);\r\n    }\r\n  }\r\n\r\n  if (\"not\" in cond) {\r\n    collectPathsFromCondition(cond.not, paths);\r\n  }\r\n\r\n  // Check comparison operators\r\n  for (const op of [\"eq\", \"neq\", \"gt\", \"gte\", \"lt\", \"lte\"]) {\r\n    if (op in cond && Array.isArray(cond[op])) {\r\n      for (const operand of cond[op] as unknown[]) {\r\n        if (\r\n          operand &&\r\n          typeof operand === \"object\" &&\r\n          \"path\" in operand &&\r\n          typeof (operand as { path: unknown }).path === \"string\"\r\n        ) {\r\n          paths.add((operand as { path: string }).path);\r\n        }\r\n      }\r\n    }\r\n  }\r\n}\r\n\r\n/**\r\n * Collect all action names used in a tree\r\n */\r\nexport function collectActions(tree: UITree): Set<string> {\r\n  const actions = new Set<string>();\r\n\r\n  traverseTree(tree, (element) => {\r\n    for (const propValue of Object.values(element.props)) {\r\n      // Check for action prop (string action name)\r\n      if (typeof propValue === \"string\" && propValue.startsWith(\"action:\")) {\r\n        actions.add(propValue.slice(7));\r\n      }\r\n\r\n      // Check for action objects\r\n      if (\r\n        propValue &&\r\n        typeof propValue === \"object\" &&\r\n        \"name\" in propValue &&\r\n        typeof (propValue as { name: unknown }).name === \"string\"\r\n      ) {\r\n        actions.add((propValue as { name: string }).name);\r\n      }\r\n    }\r\n\r\n    // Also check direct action prop\r\n    const actionProp = element.props.action;\r\n    if (typeof actionProp === \"string\") {\r\n      actions.add(actionProp);\r\n    }\r\n  });\r\n\r\n  return actions;\r\n}\r\n","/**\r\n * Options for serialization\r\n */\r\nexport interface SerializeOptions {\r\n  /** Quote style for strings */\r\n  quotes?: \"single\" | \"double\";\r\n  /** Indent for objects/arrays */\r\n  indent?: number;\r\n}\r\n\r\nconst DEFAULT_OPTIONS: Required<SerializeOptions> = {\r\n  quotes: \"double\",\r\n  indent: 2,\r\n};\r\n\r\n/**\r\n * Escape a string for use in code\r\n */\r\nexport function escapeString(\r\n  str: string,\r\n  quotes: \"single\" | \"double\" = \"double\",\r\n): string {\r\n  const quoteChar = quotes === \"single\" ? \"'\" : '\"';\r\n  const escaped = str\r\n    .replace(/\\\\/g, \"\\\\\\\\\")\r\n    .replace(/\\n/g, \"\\\\n\")\r\n    .replace(/\\r/g, \"\\\\r\")\r\n    .replace(/\\t/g, \"\\\\t\");\r\n\r\n  if (quotes === \"single\") {\r\n    return escaped.replace(/'/g, \"\\\\'\");\r\n  }\r\n  return escaped.replace(/\"/g, '\\\\\"');\r\n}\r\n\r\n/**\r\n * Serialize a single prop value to a code string\r\n *\r\n * @returns Object with `value` (the serialized string) and `needsBraces` (whether JSX needs {})\r\n */\r\nexport function serializePropValue(\r\n  value: unknown,\r\n  options: SerializeOptions = {},\r\n): { value: string; needsBraces: boolean } {\r\n  const opts = { ...DEFAULT_OPTIONS, ...options };\r\n  const q = opts.quotes === \"single\" ? \"'\" : '\"';\r\n\r\n  if (value === null) {\r\n    return { value: \"null\", needsBraces: true };\r\n  }\r\n\r\n  if (value === undefined) {\r\n    return { value: \"undefined\", needsBraces: true };\r\n  }\r\n\r\n  if (typeof value === \"string\") {\r\n    return {\r\n      value: `${q}${escapeString(value, opts.quotes)}${q}`,\r\n      needsBraces: false,\r\n    };\r\n  }\r\n\r\n  if (typeof value === \"number\") {\r\n    return { value: String(value), needsBraces: true };\r\n  }\r\n\r\n  if (typeof value === \"boolean\") {\r\n    if (value === true) {\r\n      return { value: \"true\", needsBraces: false }; // Can use shorthand\r\n    }\r\n    return { value: \"false\", needsBraces: true };\r\n  }\r\n\r\n  if (Array.isArray(value)) {\r\n    const items = value.map((v) => serializePropValue(v, opts).value);\r\n    return { value: `[${items.join(\", \")}]`, needsBraces: true };\r\n  }\r\n\r\n  if (typeof value === \"object\") {\r\n    // Check for path reference\r\n    if (\r\n      \"path\" in value &&\r\n      typeof (value as { path: unknown }).path === \"string\"\r\n    ) {\r\n      return {\r\n        value: `{ path: ${q}${escapeString((value as { path: string }).path, opts.quotes)}${q} }`,\r\n        needsBraces: true,\r\n      };\r\n    }\r\n\r\n    const entries = Object.entries(value)\r\n      .filter(([, v]) => v !== undefined)\r\n      .map(([k, v]) => {\r\n        const serialized = serializePropValue(v, opts).value;\r\n        // Use shorthand if key matches value for simple identifiers\r\n        return `${k}: ${serialized}`;\r\n      });\r\n\r\n    return { value: `{ ${entries.join(\", \")} }`, needsBraces: true };\r\n  }\r\n\r\n  return { value: String(value), needsBraces: true };\r\n}\r\n\r\n/**\r\n * Serialize props object to JSX attributes string\r\n */\r\nexport function serializeProps(\r\n  props: Record<string, unknown>,\r\n  options: SerializeOptions = {},\r\n): string {\r\n  const parts: string[] = [];\r\n\r\n  for (const [key, value] of Object.entries(props)) {\r\n    if (value === undefined || value === null) continue;\r\n\r\n    const serialized = serializePropValue(value, options);\r\n\r\n    // Boolean true can be shorthand\r\n    if (typeof value === \"boolean\" && value === true) {\r\n      parts.push(key);\r\n    } else if (serialized.needsBraces) {\r\n      parts.push(`${key}={${serialized.value}}`);\r\n    } else {\r\n      parts.push(`${key}=${serialized.value}`);\r\n    }\r\n  }\r\n\r\n  return parts.join(\" \");\r\n}\r\n"],"mappings":"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","names":[]}