<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>iframe test — json-render</title>
    <style>
      body { font-family: Inter, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial; margin: 24px; background:#f7f7fb; color:#0f172a }
      .wrap { max-width:900px; margin: 0 auto; }
      /* Grid controls for better layout */
      .controls { display:grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap:12px; margin-bottom:12px; align-items:center }
      .control-item { display:flex; flex-direction:column; gap:8px }
      .button-group { display:flex; gap:8px; flex-wrap:wrap }
      .auto { background:#10b981 }
      input[type="text"] { padding:10px 12px; border-radius:8px; border:1px solid #e6e9ef }
      button { padding:8px 12px; border-radius:8px; border:0; background:#0ea5e9; color:white; cursor:pointer }
      button.secondary { background:#94a3b8 }
      .examples { display:flex; gap:8px; flex-wrap:wrap; margin-bottom:12px }
      .examples button { background:#eef2ff; color:#3730a3; border-radius:6px; padding:6px 8px; border:0 }
      iframe { width:100%; height:720px; border:1px solid rgba(15,23,42,0.06); border-radius:8px; background:white }
      label { font-size:12px; color:#475569; margin-right:8px }
      .meta { font-size:13px; color:#475569; margin-bottom:10px }
      .help { font-size:13px; color:#334155; background:#f8fafc; padding:10px; border-radius:8px; margin-bottom:12px; border:1px solid #e2e8f0 }
    </style>
  </head>
  <body>
    <div class="wrap">
      <h1>Embed tester — json-render</h1>
      <p class="meta">Type a prompt, set the app URL (defaults to <code>http://localhost:3000/</code>), then click <strong>Load iframe</strong>. The iframe will get <code>?prompt=...</code> and your app should auto-type and submit.</p>

      <div class="controls" id="controls">
        <div class="control-item">
          <label for="appUrl">App URL</label>
        <input id="appUrl" type="text" value="https://ava9987108-json-component-generator-97poeybud.vercel.app/" />
        </div>

        <div class="control-item">
          <label for="prompt">Prompt</label>
          <input id="prompt" type="text" placeholder="Create a login form" />
        </div>

        <div class="control-item button-group">
          <button id="loadBtn">Load iframe</button>
          <button id="openBtn" class="secondary">Open new tab</button>
        </div>

        <div class="control-item button-group">
          <button id="injectGenBtn" class="secondary" title="Type into iframe and trigger Generate">Inject → Generate</button>
          <button id="injectEditBtn" class="secondary" title="Type into iframe and trigger Edit">Inject → Edit</button>
          <button id="injectAutoBtn" class="auto" title="Auto-detect: if text contains 'edit' → Edit mode, otherwise → Generate">Inject → Auto</button>
        </div>

        <div class="control-item">
          <label style="display:block; font-size:12px; color:#475569; margin-bottom:6px">Auto-inject on load</label>
          <div style="display:flex; gap:8px; align-items:center">
            <label style="font-size:12px; color:#475569; margin:0"><input id="autoInjectOnLoad" type="checkbox" /> enable</label>
            <select id="autoAction" title="Action to perform after auto-inject" style="padding:6px; border-radius:6px; border:1px solid #e6e9ef; background:white">
              <option value="auto">Auto-detect</option>
              <option value="generate">Generate</option>
              <option value="edit">Edit</option>
            </select>
          </div>
        </div>
      </div>

      <div class="examples">
        <button data-prompt="Create a login form with email and password">Login form</button>
        <button data-prompt="Build a contact form with name, email, and message">Contact form</button>
        <button data-prompt="Create a pricing table with 3 plans">Pricing table</button>
        <button data-prompt="edit: make the background yellow" style="background:#fef3c7; color:#92400e">Edit: yellow bg</button>
        <button data-prompt="edit the form to add a phone field" style="background:#fef3c7; color:#92400e">Edit: add phone</button>
        <div style="flex-basis:100%"></div>
        <div class="help">
          <strong>Quick help:</strong> Use <code>Inject → Auto</code> to let the app auto-detect "edit" in the prompt and choose Edit mode. See <a href="./IFRAME_USAGE.md">IFRAME_USAGE.md</a> for full details.
        </div>
      </div>

      <div style="margin-bottom:12px">
        <label for="iframeWidth">Iframe width</label>
        <input id="iframeWidth" type="text" value="100%" style="width:90px; margin-right:8px;" />
        <label for="iframeHeight">height</label>
        <input id="iframeHeight" type="text" value="720px" style="width:90px;" />
        <button id="applySize" class="secondary">Apply</button>
      </div>

      <iframe id="targetIframe" src="about:blank" title="json-render embed"></iframe>
    </div>

    <script>
      const appUrlInput = document.getElementById('appUrl');
      const promptInput = document.getElementById('prompt');
      const loadBtn = document.getElementById('loadBtn');
      const openBtn = document.getElementById('openBtn');
      const iframe = document.getElementById('targetIframe');
      const examples = document.querySelectorAll('.examples button');
      const iframeWidth = document.getElementById('iframeWidth');
      const iframeHeight = document.getElementById('iframeHeight');
      const applySize = document.getElementById('applySize');

      function buildUrl() {
        let base = appUrlInput.value.trim();
        if (!base) base = 'http://localhost:3000/';
        // ensure trailing slash
        if (!base.endsWith('/')) base += '/';
        const p = encodeURIComponent(promptInput.value || '');
        return base + '?prompt=' + p;
      }

      loadBtn.addEventListener('click', () => {
        const url = buildUrl();
        iframe.src = url;
      });

      openBtn.addEventListener('click', () => {
        const url = buildUrl();
        window.open(url, '_blank');
      });

      examples.forEach(b => b.addEventListener('click', (e) => {
        promptInput.value = e.currentTarget.getAttribute('data-prompt');
      }));

      applySize.addEventListener('click', () => {
        iframe.style.width = iframeWidth.value;
        iframe.style.height = iframeHeight.value;
      });

      // support pressing Enter in the prompt field
      promptInput.addEventListener('keydown', (e) => {
        if (e.key === 'Enter') {
          e.preventDefault();
          loadBtn.click();
        }
      });

      // Inject helpers - send TYPE_INPUT messages to the iframe
      const injectGenBtn = document.getElementById('injectGenBtn');
      const injectEditBtn = document.getElementById('injectEditBtn');
      const autoInjectOnLoad = document.getElementById('autoInjectOnLoad');
      const autoActionSelect = document.getElementById('autoAction');

      function sendToIframe(action) {
        const text = promptInput.value || '';
        if (!text.trim()) {
          alert('Please enter a prompt to inject');
          return;
        }
        if (!iframe.src || iframe.src === 'about:blank') {
          alert('Load the iframe first (click "Load iframe")');
          return;
        }

        // Post message to iframe to trigger typing + action
        // If action is 'auto' or undefined, don't pass action - let iframe auto-detect
        const payload = { type: 'TYPE_INPUT', text };
        if (action && action !== 'auto') {
          payload.action = action;
        }
        iframe.contentWindow.postMessage(payload, '*');
      }

      injectGenBtn.addEventListener('click', () => sendToIframe('generate'));
      injectEditBtn.addEventListener('click', () => sendToIframe('edit'));
      
      // Auto-detect button - no explicit action, iframe will check for "edit" in text
      const injectAutoBtn = document.getElementById('injectAutoBtn');
      injectAutoBtn.addEventListener('click', () => sendToIframe('auto'));

      // If auto-inject is enabled, send message to iframe after it loads
      loadBtn.addEventListener('click', () => {
        const url = buildUrl();
        iframe.src = url;
        history.replaceState(null, '', '#last=' + encodeURIComponent(url));

        if (autoInjectOnLoad.checked) {
          // Wait for iframe to load then postMessage
          const action = (autoActionSelect && autoActionSelect.value) || 'auto';
          const onLoad = () => {
            // Small delay to allow app scripts to initialize
            setTimeout(() => {
              const payload = { type: 'TYPE_INPUT', text: promptInput.value || '' };
              if (action && action !== 'auto') {
                payload.action = action;
              }
              iframe.contentWindow.postMessage(payload, '*');
            }, 350);
            iframe.removeEventListener('load', onLoad);
          };
          iframe.addEventListener('load', onLoad);
        }
      });

      // Optional: show current URL in hash for bookmarking
      // (kept for backward-compatibility)
      // loadBtn.addEventListener('click', () => {
      //   history.replaceState(null, '', '#last=' + encodeURIComponent(buildUrl()));
      // });
    </script>
  </body>
</html>